#if defined(_WIN32) || defined(_WIN64)
    #define K_NT
#elif defined(__linux__) || defined(__APPLE__) || defined(__MACH__)
    #define K_UNIX
#endif

#if __cplusplus < 201703L
#error "C++17 is the standard version. Update to C++17 or higher."
#endif

#if defined(K_NT)
#error "Windows is currently not supported"
#endif

#ifdef K_NT
#error "Windows is currently not supported"
#endif

#define VERSION "Neodymium VM v1.0.0-alpha.2 (build 7)"

#include <iostream>
#include <fstream>
#include <cstring>
#if defined(K_UNIX)
    #include <sys/stat.h>
//#elif defined(K_NT)
    // Include windows code here
#endif

#include "modules/virtualizer.h"
#include "../globals/errors.h"
#include "../archs/@ARCH@/@ARCH@.h"

int main(int argc, const char* argv[]) {
    Arch* arch = new Arch();
    
    #if defined(K_NT)
        printf("Windows is currently not supported.");
        raise(Errors::OS_UNSUPPORTED);
    #elif !defined(K_UNIX)
        printf("Your OS is currently not supported");
        raise(Errors::OS_UNSUPPORTED);
    #endif
    
    if (argc != 2) {
        raise(Errors::NO_FILE_ARG);
    }
    const char* file_name = argv[1];
    
    if (strcmp(file_name, "--version") == 0 || strcmp(file_name, "-v") == 0){
        printf("%s\n", VERSION);
        if(strlen(arch->version) != 0){
            printf("Architecture: %s\n", arch->version);
        }
        exit(0);
    }
    
    struct stat buffer;
    if (stat(file_name, &buffer) != 0){
        raise(Errors::FILE_NOT_FOUND);
    }
    
    std::ifstream in;
    in.open(file_name, std::ios::in | std::ios::binary);
    
    if (!in.is_open()) {
        raise(Errors::ERROR_OPENING_FILE);
    }
    
    arch->input_file(&in, buffer.st_size);

    Virtualizer virt = Virtualizer(arch);

    virt.run();
}